===========================================================
 PANKAKE v0.2 (being reviewed)
 Password Authentication N' Key Agreement with Key Exchange

 Copyright 2014 Pedro A. Hortas (pah@ucodev.org)

 Initial Release Date: 2014-08-17

 Author:  Pedro A. Hortas
 Email:   pah@ucodev.org
 Changed: 2014-08-26
 License: Public Domain


 Current usages and implementations:

   Project: PSEC Library
   Module:  Key Exchange
   URL:     https://github.com/ucodev/libpsec

   Project: uSched
   Module:  uSched Authentication Protocol
   URL:     https://github.com/ucodev/usched

===========================================================


1. Goals

 - Open protocol.
 - No third parties required.
 - Authenticate both parties in only 3 communications flows (client -> server -> client -> server).
 - Client challenges the server and grants that it is legit before revealing critical data.
 - Server challenges the client and grants it is legit without revealing critical data.
 - Server only stores the client's password hash and NOT the plain-text password.
 - Resistant to replay attacks.
 - Resistant to eavesdropping in all 3 communications flows.
 - Resistant to man-in-the-middle packet mangling (tampering) in all 3 communications flows.
 - Resistant to side-channel attacks (implementation dependent, but easy to achieve).
 - Resistant to dictionary attacks.
 - Resistant to decryption based on FPGA/CPLD.
 - Resistant to decryption based on quantum computing.
 - An attacker who discloses the password or password hash won't be able to decrypt past connections.
 - Constant processing time regardeless of input, either if correct or incorrect.
 - A strong Agreed Key, that's NOT based on the password or password hash, is computed by both parties.


2. Notes

 - Salt is known either by client and server.
 - If salt isn't known by client, it may be transfered from server in plain text.
 - A username may be used as the salt.
 - Diffie-Hellman key exchange should be eliptic curve based.
 - Diffie-Hellman public key exchange is performed in the first two flows (client -> server -> client).
 - Diffie-Hellman private and public keys may be stored and reused.
 - Diffie-Hellman shared key must be of the same size of secret hash.
 - Client token must be a random value with a minimum length of 256 bits.
 - Server token must be a random value with at least half the length of the client token.
 - Password hashes length must be at least twice the length of client token.
 - All xor() operations must grant that both operands are of the same size.
 - All encrypt() operations should *not add* any sort of Message Authentication Code (MAC).
 - All encrypt_mac() operations should *add* a Message Authentication Code (MAC).
 - All encrypt() and encrypt_mac() operations should use a nonce based feature.
 - When encryption keys exceed the expected size, Blake2s should be used to shrink them.
 - When encryption keys are under the expected size, Blake2p should be used to grow them.
 - It is recommended to use Curve25519 for Eliptic Curve Diffie-Hellman.
 - It is recommended to use ChaCha20 for encrypt() and decrypt() operations.
 - It is recommended to use ChaCha20+Poly1305 for encrypt_mac() and decrypt_mac() operations.
 - It is recommended to use PBKDF2-SHA-512 for key derivation of the plain text passwords.
 - PBKDF2 iterations should be at least 5000.
 - All communications after successful authentication may use the Agreed Key for encryption.
 - None of the exchanged tokens between the parties should live beyond the authentication procedures.
 - The client auth must have the same size in all authentications regardless of the password size.


3. Operators

 +---------+--------------+---------------------------------------------------+
 | oper    | usage        | description                                       |
 +---------+--------------+---------------------------------------------------+
 | | |     | |v|          | length of 'v'                                     |
 | []      | v[]          | vectorization                                     |
 | [i]     | v[i]         | value of vector position 'i' (1 <= i <= |v|)      |
 | [:]     | v[x1:x2]     | range from 'x1' to 'x2' (1 <= x1 < x2)            |
 | =       | a = b        | assigns 'b' to 'a'                                |
 | **      | b**e         | exponentiation ('b' is base, 'e' is exponent)     |
 | mod     | a mod b      | modulo ('a' modulo 'b')                           |
 | +       | a + b        | summation ('a' plus 'b')                          |
 | -       | a - b        | subtraction ('a' minus 'b')                       |
 | *       | a * b        | multiplication ('a' times 'b')                    |
 | /       | a / b        | division ('a' divided by 'b')                     |
 | ||      | a || b       | concatenation of 'a' and 'b' into 'm' (m = a || b)|
 | < >     | a <m> b      | split 'm' into 'a' and 'b'                        |
 | ^       | a ^ b        | XOR (same as xor(a, b))                           |
 | ==      | a == b       | equality comparision (same as compare(a, b))      |
 | !=      | a != b       | non-equality comparision                          |
 +---------+--------------+---------------------------------------------------+
 

4. Functions

 +------------------+---------------------------------------------------------+
 | function         | description                                             |
 +------------------+---------------------------------------------------------+
 | concat(a, b)     | concatenate variables 'a' and 'b' into 'm' (m = a || b) |
 | compare(a, b)    | constant time comparing function (a == b)               |
 |                  |                                                         |
 | dec(m, k)        | ChaCha20 decryption                                     |
 | dec_mac(m, k)    | ChaCha20 decryption with Poly1305 authentication        |
 |                  |                                                         |
 | enc(m, k)        | ChaCha20 encryption                                     |
 | enc_mac(m, k)    | ChaCha20 encryption with Poly1305 authentication        |
 |                  |                                                         |
 | fail()           | Interrupt execution                                     |
 |                  |                                                         |
 | pbkdf2(pw, salt) | PBKDF2 key derivation based on SHA-512 with 5000 rounds |
 |                  |                                                         |
 | proceed()        | proceed execution                                       |
 |                  |                                                         |
 | random()         | strong pseudo-random generator                          |
 |                  |                                                         | 
 | split(m)         | splits variable 'm' into 'a' and 'b' (a <m> b)          |
 |                  |                                                         |
 | xor(a, b)        | a ^ b                                                   |
 +------------------+---------------------------------------------------------+


5. Variables

 +------+-----------------------+----------------------+----------------------+
 | var  | description           | client computation   | server computation   |
 +------+-----------------------+----------------------+----------------------+
 | g    | generator             | <known>              | <known>              |
 | p    | prime                 | <known>              | <known>              |
 |      |                       |                      |                      |
 | l    | cpwh or spwh length   | |cpwh|               | |spwh|               |
 |      |                       |                      |                      |
 | salt | username              | <known>              | <known>              |
 | pw   | plain password        | <known>              | dec(ca, ak)          |
 |      |                       |                      |                      |
 | cpub | client public key     | g**cprv mod p        | <received>           |
 | spub | server public key     | <received>           | g**sprv mod p        |
 |      |                       |                      |                      |
 | cprv | client private key    | random()             | <unknown>            |
 | sprv | server private key    | <unknown>            | random()             |
 |      |                       |                      |                      |
 | cpwh | client password hash  | pbkdf2(pw, salt)     | <unknown>            |
 | spwh | server password hash  | <unknown>            | <known>              |
 |      |                       |                      |                      |
 | ca   | client auth           | enc(ak, pw)          | <received>           |
 | sa   | server auth           | dec(sk, ss)          | xor(sh, spwh[l/2:l]) |
 |      |                       |                      |                      |
 | cs   | client session        | xor(cpwh[1:l/2], ct) | <received>           |
 | ss   | server session        | <received>           | enc(sa, sk)          |
 |      |                       |                      |                      |
 | ct   | client token          | random()             | xor(cs, spwh[1:l/2]) |
 | st   | server token          | dec_mac(sh, ct)      | random()             |
 |      |                       |                      |                      |
 | sh   | secret hash           | xor(sa, cpwh[l/2:l]) | enc_mac(st, ct)      |
 | sk   | shared key            | spub**cprv mod p     | cpub**sprv mod p     |
 | ak   | agreed key            | enc(sh, sk)          | enc(sh, sk)          |
 +------+-----------------------+----------------------+----------------------+


6. Procedures

 - Client [Stage #1]

   *     cprv = random()
   *     cpub = g**cprv mod p
   *     cpwh = pbkdf2(pw, salt)
   *       cs = xor(cpwh[1:l/2], ct)
   *      msg = concat(cpub, cs)
   >             <client sends 'msg' to server>

 - Server [Stage #2]

   * cpub, cs = split(msg)
   *     sprv = random()
   *     spub = g**sprv mod p
   *       sk = cpub**sprv mod p
   *       ct = xor(cs, spwh[1:l/2])
   *       st = random()
   *       sh = enc_mac(st, ct)
   *       sa = xor(sh, spwh[l/2:l])
   *       ss = enc(sa, sk)
   *      msg = concat(spub, ss)
   >             <server sends 'msg' to client>

 - Client [Stage #3]

   * spub, ss = split(msg)
   *       sk = spub**cprv mod p
   *       sa = dec(ss, sk)
   *       sh = xor(sa, cpwh[l/2:l])
   *       st = dec_mac(sh, ct)
   >             <on success proceed(), otherwise fail()>
   *       ak = enc(sh, sk)
   *       ca = enc(pw, ak)
   *      msg = ca
   >             <client sends 'msg' to server>

 - Server [Stage #4]

   *      ca = msg
   *      ak = enc(sh, sk)
   *      pw = dec(ca, ak)
   *    cpwh = pbkdf2(pw, salt)
   *     ret = compare(cpwh, spwh)
   >            <if 'ret' is true then proceed(), else fail()>


7. Diagram

 - <M> stands for message.
 - <K> stands for key.
 - <OK> stands for expected result.
 - <NOT> stands for unexpected result.
 - Diffie-Hellman computations are implicit (as in, not shown in the diagram).

______________________________________________________________________________________________
                                            |     |
                   Client                   |  A  |                   Server
                                            |  T  |
                                            |  T  |
    +----------------+ +----------------+   |  A  |
    |                | |                |   |  C  |
    | plain password | |      salt      |   |  K  |
    |                | |                |   |  E  |
    +----------------+ +----------------+   |  R  |
            |                   |           |     |
            +---------+---------+           |     |
                      |                     |     |
                 __________                 |     |
                / pbkdf2() \                |     |
                \__________/                |     |
                      |                     |     |
            +---------+                     |     |
            |                               |     |
    +----------------+ +----------------+   |     |
    |                | |                |   |     |
    |  pwhash[1:l/2] | |  client token  |   |     |
    |                | |                |   |     |
    +----------------+ +----------------+   |     |
            |                  |            |     |
            +---------+--------+            |     |
                      |                     |     |
                 __________                 |     |
                /   xor()  \                |     |
                \__________/                |     |
                      |                     |     |
              +----------------+            |     |   +----------------+ +----------------+
              |  C DH pub key  |            |     |   |  C DH pub key  | |                |
              |       ||       |--------------------->|       ||       | |  pwhash[1:l/2] |
              | client session |            |     |   | client session | |                |
              +----------------+            |     |   +----------------+ +----------------+
                                            |     |            |                 |
                                            |     |            +--------+--------+
                                            |     |                     |
                                            |     |                 __________
                                            |     |                /   xor()  \
                                            |     |                \__________/
                                            |     |                     |
                                            |     |                     +--------+
                                            |     |                              |
                                            |     |   +----------------+ +----------------+
                                            |     |   |                | |                |
                                            |     |   |  server token  | |  client token  |
                                            |     |   |                | |                |
                                            |     |   +----------------+ +----------------+
                                            |     |            |                 |
                                            |  A  |            +--<M>---+---<K>--+
                                            |  T  |                     |
                                            |  T  |               _______________
                                            |  A  |              / encrypt_mac() \
                                            |  C  |              \_______________/
                                            |  K  |                     |
                                            |  E  |            +--------+
                                            |  R  |            |
                                            |     |   +----------------+ +----------------+
                                            |     |   |                | |                |
                                            |     |   |   secret hash  | |  pwhash[l/2:l] |
                                            |     |   |                | |                |
                                            |     |   +----------------+ +----------------+
                                            |     |            |                 |
                                            |     |            +--------+--------+
                                            |     |                     |
                                            |     |                 __________
                                            |     |                /   xor()  \
                                            |     |                \__________/
                                            |     |                     |
                                            |     |            +--------+
                                            |     |            |
                                            |     |   +----------------+ +----------------+
                                            |     |   |                | |                |
                                            |     |   |   server auth  | |  DH shared key |
                                            |     |   |                | |                |
                                            |     |   +----------------+ +----------------+
                                            |     |            |                 |
                                            |     |            +--<M>---+---<K>--+
                                            |     |                     |
                                            |     |                ___________
                                            |     |               / encrypt() \
                                            |     |               \___________/
                                            |     |                     |
    +----------------+ +----------------+   |     |             +----------------+
    |                | |  S DH pub key  |   |     |             |  S DH pub key  |
    |  DH shared key | |       ||       |<----------------------|       ||       |
    |                | | server session |   |     |             | server session |
    +----------------+ +----------------+   |     |             +----------------+
            |                  |            |     |
            +--<K>----+---<M>--+            |     |
                      |                     |     |
                 ___________                |     |
                / decrypt() \               |     |
                \___________/               |     |
                      |                     |     |
                      +--------+            |     |
                               |            |     |
    +----------------+ +----------------+   |     |
    |                | |                |   |     |
    |  pwhash[l/2:l] | |  server auth   |   |     |
    |                | |                |   |     |
    +----------------+ +----------------+   |     |
            |                  |            |     |
            +---------+--------+            |  A  |
                      |                     |  T  |
                  __________                |  T  |
                 /   xor()  \               |  A  |
                 \__________/               |  C  |
                      |                     |  K  |
                      +--------+            |  E  |
                               |            |  R  |
    +----------------+ +----------------+   |     |
    |                | |                |   |     |
    |  client token  | |  secret hash   |   |     |
    |                | |                |   |     |
    +----------------+ +----------------+   |     |
            |                  |            |     |
            +--<K>----+---<M>--+            |     |
                      |                     |     |
              _______________               |     |
             / decrypt_mac() \              |     |
             \_______________/              |     |
                      |                     |     |
            +--<OK>---+--<NOK>-+            |     |
            |                  |            |     |
        ___________        _________        |     |
       / proceed() \      /  fail() \       |     |
       \___________/      \_________/       |     |
            |                               |     |
            +---------+                     |     |
    +----------------+ +----------------+   |     |
    |                | |                |   |     |
    |  secret hash   | |  DH shared key |   |     |
    |                | |                |   |     |
    +----------------+ +----------------+   |     |
            |                  |            |     |
            +--<K>----+---<M>--+            |     |
                      |                     |     |
                 ___________                |     |
                / encrypt() \               |     |
                \___________/               |     |
                      |                     |     |
            +---------+                     |     |   +----------------+ +----------------+
            |                               |     |   |                | |                |
    +----------------+ +----------------+   |     |   |  DH shared key | |   secret hash  |
    |                | |                |   |     |   |                | |                |
    |   Agreed Key   | | plain password |   |     |   +----------------+ +----------------+
    |                | |                |   |     |            |                 |
    +----------------+ +----------------+   |     |            +--<M>---+---<K>--+
            |                  |            |     |                     |
            +--<K>----+---<M>--+            |     |                ___________
                      |                     |     |               / encrypt() \
                 ___________                |     |               \___________/
                / encrypt() \               |     |                     |
                \___________/               |     |                     +--------+
                      |                     |     |                              |
              +----------------+            |     |   +----------------+ +----------------+
              |                |            |     |   |                | |                |
              |  client auth   |--------------------->|  client auth   | |   Agreed Key   |
              |                |            |     |   |                | |                |
              +----------------+            |     |   +----------------+ +----------------+
                                            |     |            |                 |
                                            |     |            +--<M>---+---<K>--+
                                            |     |                     |
                                            |  A  |                ___________
                                            |  T  |               / decrypt() \
                                            |  T  |               \___________/
                                            |  A  |                     |
                                            |  C  |            +--------+
                                            |  K  |            |
                                            |  E  |   +----------------+ +----------------+
                                            |  R  |   |                | |                |
                                            |     |   | plain password | |      salt      |
                                            |     |   |                | |                |
                                            |     |   +----------------+ +----------------+
                                            |     |            |                 |
                                            |     |            +--------+--------+
                                            |     |                     |
                                            |     |                ___________
                                            |     |               /  pbkdf2() \
                                            |     |               \___________/
                                            |     |                     |
                                            |     |            +--------+
                                            |     |            |
                                            |     |   +----------------+ +----------------+
                                            |     |   |                | |                |
                                            |     |   | CLIENT pwhash  | | SERVER pwhash  |
                                            |     |   |   (computed)   | |    (stored)    |
                                            |     |   +----------------+ +----------------+
                                            |     |            |                 |
                                            |     |            +--------+--------+
                                            |     |                     |
                                            |     |                ___________
                                            |     |               / compare() \
                                            |     |               \___________/
                                            |     |                     |
                                            |     |            +--<OK>--+--<NOK>--+
                                            |     |            |                  |
                                            |     |       ___________        ___________ 
                                            |     |      / proceed() \      /   fail()  \
                                            |     |      \___________/      \___________/
                                            |     |
